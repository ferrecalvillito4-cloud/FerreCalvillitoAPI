<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Progreso Im√°genes ‚Äî Panel</title>
    <style>
         :root {
            --bg1: #667eea;
            --bg2: #764ba2;
            --card-bg: #ffffff;
            --muted: #666;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }
        
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .layout {
            max-width: 1400px;
            margin: 0 auto;
            border-radius: 20px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.35);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(250, 250, 250, 0.98));
            overflow: hidden;
        }
        
        header {
            padding: 22px 32px;
            display: flex;
            align-items: center;
            gap: 18px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.35));
        }
        
        header h1 {
            font-size: 20px;
            color: var(--bg1);
        }
        
        .main {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 22px;
            padding: 26px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 6px 18px rgba(18, 18, 18, 0.04);
        }
        
        .estado {
            font-size: 60px;
            text-align: center;
            color: var(--bg1);
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 14px;
        }
        
        .btn {
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 9px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--bg1), var(--bg2));
            color: #fff;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fff;
        }
        
        .btn-danger {
            background: linear-gradient(90deg, var(--danger), #dc2626);
            color: #fff;
        }
        
        .btn-info {
            background: #3b82f6;
            color: #fff;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .progress-container {
            margin-top: 18px;
            background: #f3f4f6;
            border-radius: 12px;
            height: 44px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            transition: width 0.6s ease;
            background: linear-gradient(90deg, var(--bg1), var(--bg2));
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8fafc;
            padding: 14px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card .label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 22px;
            color: #111;
            font-weight: 800;
            margin-top: 6px;
        }
        
        .badge {
            padding: 8px 12px;
            border-radius: 999px;
            background: #eef2ff;
            color: var(--bg1);
            font-weight: 700;
            font-size: 13px;
        }
        /* Modal */
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: #111;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .pagination-info {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }
        
        .pagination-buttons {
            display: flex;
            gap: 8px;
        }
        
        .producto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .producto-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 12px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .producto-card:hover {
            border-color: var(--bg1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .producto-card.con-imagen {
            background: #ecfdf5;
            border-color: #d1fae5;
        }
        
        .producto-card.sin-imagen {
            background: #fef3c7;
            border-color: #fde68a;
        }
        
        .producto-imagen {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .producto-codigo {
            font-weight: 700;
            color: var(--bg1);
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .producto-nombre {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .producto-estado {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .estado-con {
            background: #10b981;
            color: white;
        }
        
        .estado-sin {
            background: #f59e0b;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }
        
        .small {
            color: var(--muted);
            font-size: 13px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }
        
        .alert-error {
            background: #fee;
            color: #c00;
        }
        
        .alert-success {
            background: #efe;
            color: #060;
        }
        
        .alert-info {
            background: #eef;
            color: #006;
        }
        
        .log {
            max-height: 200px;
            overflow: auto;
            background: #0b1221;
            color: #9ff1b0;
            padding: 10px;
            border-radius: 8px;
            font-family: "Courier New", monospace;
            font-size: 12px;
        }
        
        @media (max-width: 900px) {
            .main {
                grid-template-columns: 1fr;
            }
            .producto-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            .pagination-controls {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="layout">
        <header>
            <h1>üñºÔ∏è Gestor de Im√°genes ‚Äî FerreCalvillito</h1>
            <div style="flex:1"></div>
            <span class="badge" id="badge-estado">Conectando</span>
        </header>

        <div class="main">
            <section class="card">
                <div style="display:flex;gap:18px;align-items:center">
                    <div id="estado" class="estado">‚è≥</div>
                    <div style="flex:1">
                        <div id="mensaje" style="margin-bottom:8px;color:#666">Conectando...</div>
                        <div class="controls">
                            <button id="btn-procesar" class="btn btn-primary" onclick="procesarImagenes()">
                                ‚ñ∂Ô∏è Procesar 50
                            </button>
                            <button class="btn btn-success" onclick="verProductosConImagen()">
                                ‚úÖ Ver Con Imagen
                            </button>
                            <button class="btn btn-warning" onclick="verProductosSinImagen()">
                                ‚è≥ Ver Sin Imagen
                            </button>
                            <button class="btn btn-info" onclick="verEstadisticas()">
                                üìä Estad√≠sticas
                            </button>
                        </div>
                    </div>
                </div>

                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar" style="width:0%">0%</div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="label">Total</div>
                        <div id="total" class="value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Con Imagen</div>
                        <div id="con-imagen" class="value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Sin Imagen</div>
                        <div id="sin-imagen" class="value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Tiempo Est.</div>
                        <div id="tiempo" class="value" style="font-size:18px">-</div>
                    </div>
                </div>

                <div id="error" class="alert alert-error"></div>
                <div id="success" class="alert alert-success"></div>
                <div id="info" class="alert alert-info"></div>
            </section>

            <aside>
                <div class="card">
                    <h3 style="margin-bottom:8px">Actividad</h3>
                    <div class="log" id="log">Iniciando panel...\n</div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal para mostrar productos -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Productos</h2>
                <button class="modal-close" onclick="cerrarModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="modal-content" class="producto-grid"></div>
            </div>
            <div class="pagination-controls">
                <div class="pagination-info" id="pagination-info">
                    Mostrando 1-50 de 1000
                </div>
                <div class="pagination-buttons">
                    <button class="btn btn-sm btn-info" onclick="irInicio()" id="btn-inicio">
                        ‚èÆÔ∏è Inicio
                    </button>
                    <button class="btn btn-sm btn-info" onclick="paginaAnterior()" id="btn-anterior">
                        ‚óÄÔ∏è Anterior
                    </button>
                    <button class="btn btn-sm btn-info" onclick="paginaSiguiente()" id="btn-siguiente">
                        Siguiente ‚ñ∂Ô∏è
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let procesando = false;
        let paginaActual = 0;
        let tipoActual = ''; // 'con' o 'sin'
        let totalProductos = 0;
        const LIMITE = 50;
        const logEl = document.getElementById('log');

        function pushLog(line) {
            const ts = new Date().toLocaleTimeString();
            logEl.textContent = `${ts} ‚Äî ${line}\n` + logEl.textContent;
            if (logEl.textContent.length > 10000) {
                logEl.textContent = logEl.textContent.slice(0, 10000);
            }
        }

        function showAlert(type, msg) {
            const el = document.getElementById(type);
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        async function callApi(path, opts = {}) {
            try {
                const res = await fetch(path, {
                    ...opts,
                    headers: {
                        'Content-Type': 'application/json',
                        ...opts.headers
                    }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (err) {
                pushLog(`‚ùå API Error: ${err.message}`);
                throw err;
            }
        }

        async function procesarImagenes() {
            try {
                procesando = true;
                document.getElementById('btn-procesar').disabled = true;
                document.getElementById('estado').textContent = '‚öôÔ∏è';
                showAlert('info', '‚è≥ Procesando 50 productos...');
                pushLog('Iniciando procesamiento...');

                const data = await callApi('/api/productos/procesar-imagenes-manual', {
                    method: 'POST'
                });

                if (data.ok) {
                    showAlert('success', data.mensaje);
                    pushLog(`‚úÖ ${data.mensaje}`);
                } else {
                    showAlert('error', data.error);
                    pushLog(`‚ùå ${data.error}`);
                }
            } catch (err) {
                showAlert('error', 'Error al procesar');
                pushLog(`‚ùå ${err.message}`);
            } finally {
                setTimeout(() => {
                    procesando = false;
                    document.getElementById('btn-procesar').disabled = false;
                    actualizarProgreso();
                }, 2000);
            }
        }

        function abrirModal(titulo) {
            document.getElementById('modal-title').textContent = titulo;
            document.getElementById('modal').classList.add('show');
        }

        function cerrarModal() {
            document.getElementById('modal').classList.remove('show');
            paginaActual = 0;
        }

        function actualizarPaginacionUI() {
            const inicio = paginaActual * LIMITE + 1;
            const fin = Math.min((paginaActual + 1) * LIMITE, totalProductos);
            document.getElementById('pagination-info').textContent =
                `Mostrando ${inicio.toLocaleString()}-${fin.toLocaleString()} de ${totalProductos.toLocaleString()}`;

            // Deshabilitar botones seg√∫n la p√°gina
            document.getElementById('btn-inicio').disabled = paginaActual === 0;
            document.getElementById('btn-anterior').disabled = paginaActual === 0;
            document.getElementById('btn-siguiente').disabled = fin >= totalProductos;
        }

        async function cargarPagina(tipo, offset) {
            const content = document.getElementById('modal-content');
            content.innerHTML = '<div class="loading">‚è≥ Cargando productos...</div>';

            try {
                const endpoint = tipo === 'con' ?
                    `/api/productos/con-imagen?limite=${LIMITE}&offset=${offset}` :
                    `/api/productos/sin-imagen?limite=${LIMITE}&offset=${offset}`;

                const data = await callApi(endpoint);

                if (data.ok) {
                    totalProductos = data.total;
                    actualizarPaginacionUI();

                    if (data.productos.length > 0) {
                        if (tipo === 'con') {
                            content.innerHTML = data.productos.map(p => `
                                <div class="producto-card con-imagen">
                                    <img src="${p.url_imagen}" class="producto-imagen" 
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%23999%22%3ENo disponible%3C/text%3E%3C/svg%3E'"
                                         alt="${p.nombre}">
                                    <div class="producto-codigo">${p.codigo}</div>
                                    <div class="producto-nombre">${p.nombre}</div>
                                    <span class="producto-estado estado-con">‚úÖ ${p.fuente}</span>
                                </div>
                            `).join('');
                        } else {
                            content.innerHTML = data.productos.map(p => `
                                <div class="producto-card sin-imagen">
                                    <div style="height:150px;background:#fde68a;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:8px;font-size:48px">
                                        ‚ùì
                                    </div>
                                    <div class="producto-codigo">${p.codigo}</div>
                                    <div class="producto-nombre">${p.nombre}</div>
                                    <span class="producto-estado estado-sin">‚è≥ Pendiente</span>
                                </div>
                            `).join('');
                        }
                        pushLog(`üìÑ P√°gina ${paginaActual + 1} cargada (${data.productos.length} productos)`);
                    } else {
                        content.innerHTML = '<div class="loading">No hay m√°s productos</div>';
                    }
                } else {
                    content.innerHTML = '<div class="loading">‚ùå Error al cargar</div>';
                }
            } catch (err) {
                content.innerHTML = '<div class="loading">‚ùå Error al cargar</div>';
                pushLog(`‚ùå ${err.message}`);
            }
        }

        async function verProductosConImagen() {
            tipoActual = 'con';
            paginaActual = 0;
            abrirModal('‚úÖ Productos CON Imagen');
            await cargarPagina('con', 0);
        }

        async function verProductosSinImagen() {
            tipoActual = 'sin';
            paginaActual = 0;
            abrirModal('‚è≥ Productos SIN Imagen');
            await cargarPagina('sin', 0);
        }

        function irInicio() {
            paginaActual = 0;
            cargarPagina(tipoActual, 0);
        }

        function paginaAnterior() {
            if (paginaActual > 0) {
                paginaActual--;
                cargarPagina(tipoActual, paginaActual * LIMITE);
            }
        }

        function paginaSiguiente() {
            const maxPagina = Math.ceil(totalProductos / LIMITE) - 1;
            if (paginaActual < maxPagina) {
                paginaActual++;
                cargarPagina(tipoActual, paginaActual * LIMITE);
            }
        }

        async function verEstadisticas() {
            abrirModal('üìä Estad√≠sticas Detalladas');
            const content = document.getElementById('modal-content');
            content.innerHTML = '<div class="loading">‚è≥ Cargando estad√≠sticas...</div>';

            // Ocultar controles de paginaci√≥n para estad√≠sticas
            document.querySelector('.pagination-controls').style.display = 'none';

            try {
                const data = await callApi('/api/productos/estadisticas-imagenes');

                if (data.ok) {
                    const r = data.resumen;
                    const e = data.estimaciones;
                    content.innerHTML = `
                        <div style="background:#f8fafc;padding:20px;border-radius:10px">
                            <h3 style="margin-bottom:16px">üìä Resumen General</h3>
                            <div style="display:grid;gap:12px">
                                <div><strong>Total productos:</strong> ${r.total_productos.toLocaleString()}</div>
                                <div><strong>Con nombre v√°lido:</strong> ${r.con_nombre.toLocaleString()}</div>
                                <div><strong>Sin nombre:</strong> ${r.sin_nombre.toLocaleString()}</div>
                                <div style="color:#10b981"><strong>‚úÖ Con imagen:</strong> ${r.con_imagen.toLocaleString()}</div>
                                <div style="color:#f59e0b"><strong>‚è≥ Sin imagen:</strong> ${r.sin_imagen.toLocaleString()}</div>
                                <div><strong>Progreso:</strong> ${r.porcentaje_completado.toFixed(2)}%</div>
                                <hr>
                                <h3 style="margin-top:12px">‚è±Ô∏è Estimaciones</h3>
                                <div><strong>Tiempo restante:</strong> ${e.tiempo_restante_50x}</div>
                                <div><strong>Lotes necesarios:</strong> ${e.lotes_necesarios_50}</div>
                                <div><strong>Con pausas (15s):</strong> ${e.tiempo_con_pausas}</div>
                            </div>
                        </div>
                    `;
                    pushLog('üìä Estad√≠sticas cargadas');
                }
            } catch (err) {
                content.innerHTML = '<div class="loading">‚ùå Error al cargar estad√≠sticas</div>';
                pushLog(`‚ùå ${err.message}`);
            }
        }

        async function actualizarProgreso() {
            try {
                const data = await callApi('/producto');
                const total = data.length;
                const conImagen = data.filter(p => p.imagen && p.imagen.url_github).length;
                const sinImagen = total - conImagen;
                const porcentaje = total > 0 ? ((conImagen / total) * 100).toFixed(1) : 0;

                if (!procesando) {
                    document.getElementById('estado').textContent = 'üìä';
                }
                document.getElementById('mensaje').textContent = `${conImagen.toLocaleString()} de ${total.toLocaleString()} productos con imagen`;
                document.getElementById('badge-estado').textContent = procesando ? 'Procesando' : 'Conectado';

                document.getElementById('progress-bar').style.width = porcentaje + '%';
                document.getElementById('progress-bar').textContent = porcentaje + '%';

                document.getElementById('total').textContent = total.toLocaleString();
                document.getElementById('con-imagen').textContent = conImagen.toLocaleString();
                document.getElementById('sin-imagen').textContent = sinImagen.toLocaleString();

                if (sinImagen > 0) {
                    const min = Math.ceil((sinImagen / 50) * 2);
                    document.getElementById('tiempo').textContent = min < 60 ? `${min}m` : `${Math.floor(min/60)}h ${min%60}m`;
                } else {
                    document.getElementById('tiempo').textContent = '‚úÖ Completo';
                }

                pushLog(`‚úÖ ${conImagen}/${total} (${porcentaje}%)`);
            } catch (err) {
                document.getElementById('badge-estado').textContent = 'Error';
                pushLog(`‚ùå ${err.message}`);
            }
        }

        // Cerrar modal al hacer click fuera
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') cerrarModal();
        });

        // Mostrar controles de paginaci√≥n cuando se abre el modal (excepto estad√≠sticas)
        const modalObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const modal = document.getElementById('modal');
                    const paginationControls = document.querySelector('.pagination-controls');
                    if (modal.classList.contains('show') && tipoActual !== '') {
                        paginationControls.style.display = 'flex';
                    }
                }
            });
        });

        modalObserver.observe(document.getElementById('modal'), {
            attributes: true
        });

        // Iniciar
        actualizarProgreso();
        setInterval(actualizarProgreso, 5000);
        pushLog('Panel iniciado correctamente');
    </script>
</body>

</html>