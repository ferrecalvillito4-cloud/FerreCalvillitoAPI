<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Progreso Im√°genes ‚Äî Panel</title>
    <style>
         :root {
            --bg1: #667eea;
            --bg2: #764ba2;
            --card-bg: #ffffff;
            --muted: #666;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.85);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }
        
        html,
        body {
            height: 100%
        }
        
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px;
            min-height: 100vh;
        }
        
        .layout {
            width: 100%;
            max-width: 980px;
            border-radius: 20px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.35);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(250, 250, 250, 0.98));
            overflow: hidden;
        }
        
        header {
            padding: 22px 32px;
            display: flex;
            align-items: center;
            gap: 18px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.35));
        }
        
        header h1 {
            font-size: 20px;
            color: var(--bg1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        header .subtitle {
            color: var(--muted);
            font-size: 13px;
            margin-left: 6px;
        }
        
        .main {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 22px;
            padding: 26px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 6px 18px rgba(18, 18, 18, 0.04);
        }
        
        .top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        
        .estado {
            font-size: 60px;
            text-align: center;
            color: var(--bg1);
            min-width: 120px;
        }
        
        .mensaje {
            color: var(--muted);
            font-size: 15px;
            min-height: 48px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 14px;
        }
        
        .btn {
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 9px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            transition: opacity 0.2s;
        }
        
        .btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
            box-shadow: none
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--bg1), var(--bg2));
            color: #fff
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, var(--warning), #d97706);
            color: #fff
        }
        
        .btn-info {
            background: #3b82f6;
            color: #fff
        }
        
        .btn-danger {
            background: linear-gradient(90deg, var(--danger), #dc2626);
            color: #fff
        }
        
        .progress-container {
            margin-top: 18px;
            background: #f3f4f6;
            border-radius: 12px;
            height: 44px;
            overflow: hidden;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.03);
        }
        
        .progress-bar {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            transition: width 0.6s ease;
            background: linear-gradient(90deg, var(--bg1), var(--bg2));
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8fafc;
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            transition: transform .12s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.05)
        }
        
        .stat-card .label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px
        }
        
        .stat-card .value {
            font-size: 22px;
            color: #111;
            font-weight: 800;
            margin-top: 6px
        }
        
        .timestamp {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 14px
        }
        
        aside.right {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        .panel {
            padding: 16px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), #fff);
            box-shadow: 0 6px 20px rgba(2, 6, 23, 0.03);
        }
        
        .panel h3 {
            font-size: 14px;
            color: #334155;
            margin-bottom: 8px;
        }
        
        .log {
            max-height: 240px;
            overflow: auto;
            background: #0b1221;
            color: #9ff1b0;
            padding: 10px;
            border-radius: 8px;
            font-family: "Courier New", monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .debug-panel {
            display: none
        }
        
        .debug-panel pre {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            max-height: 220px;
            overflow: auto;
            font-size: 12px;
        }
        
        .small {
            color: var(--muted);
            font-size: 13px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }
        
        .alert-error {
            background: #fee;
            color: #c00;
            border: 1px solid #fcc;
        }
        
        .alert-success {
            background: #efe;
            color: #060;
            border: 1px solid #cfc;
        }
        
        .alert-info {
            background: #eef;
            color: #006;
            border: 1px solid #ccf;
        }
        
        footer {
            padding: 14px 26px;
            border-top: 1px solid rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25));
        }
        
        .badge {
            padding: 8px 12px;
            border-radius: 999px;
            background: #eef2ff;
            color: var(--bg1);
            font-weight: 700;
            font-size: 13px;
        }
        
        @media (max-width:900px) {
            .main {
                grid-template-columns: 1fr
            }
            aside.right {
                order: 2
            }
        }
    </style>
</head>

<body>
    <div class="layout" role="main">
        <header>
            <h1>üñºÔ∏è Progreso de Im√°genes <span class="subtitle">‚Äî Gestor FerreCalvillito</span></h1>
            <div style="flex:1"></div>
            <div class="small">Estado: <span class="badge" id="badge-estado">Conectando</span></div>
        </header>

        <div class="main">
            <section class="card">
                <div class="top-row">
                    <div style="display:flex;gap:18px;align-items:center">
                        <div id="estado" class="estado">‚è≥</div>
                        <div style="min-width:260px">
                            <div id="mensaje" class="mensaje">Conectando con el servidor...</div>
                            <div class="controls">
                                <button id="btn-procesar" class="btn btn-primary" onclick="procesarImagenes()">‚ñ∂Ô∏è Procesar</button>
                                <button id="btn-debug" class="btn btn-info" onclick="verDebug()">üîç Debug</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar" style="width:0%">0%</div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="label">Total Productos</div>
                        <div id="total" class="value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Con Imagen</div>
                        <div id="con-imagen" class="value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Sin Imagen</div>
                        <div id="sin-imagen" class="value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Tiempo Estimado</div>
                        <div id="tiempo" class="value" style="font-size:18px">-</div>
                    </div>
                </div>

                <div class="timestamp" id="timestamp">√öltima actualizaci√≥n: -</div>

                <div id="error" class="alert alert-error"></div>
                <div id="success" class="alert alert-success"></div>
                <div id="info" class="alert alert-info"></div>
            </section>

            <aside class="right">
                <div class="panel">
                    <h3>Actividad</h3>
                    <div class="small">√öltimos eventos del gestor</div>
                    <div style="height:12px"></div>
                    <div id="log" class="log">Iniciando panel...\n</div>
                </div>

                <div class="panel debug-panel" id="debug-panel">
                    <h3>Debug (raw)</h3>
                    <pre id="debug-content">‚Äî</pre>
                </div>

                <div class="panel">
                    <h3>Acciones r√°pidas</h3>
                    <p class="small">Usa los botones para controlar el procesador.</p>
                    <div style="display:grid;gap:8px;margin-top:8px">
                        <button class="btn btn-primary" onclick="window.location.reload()">üîÑ Recargar</button>
                        <button class="btn btn-info" onclick="copiarEstado()">üìã Copiar estado</button>
                    </div>
                </div>
            </aside>
        </div>

        <footer>
            <div class="small">Built: Panel v2 ‚Äî FerreCalvillito</div>
            <div class="small">API: <strong>/api/productos/</strong></div>
        </footer>
    </div>

    <script>
        let errorCount = 0;
        const logEl = document.getElementById('log');
        const debugPanel = document.getElementById('debug-panel');
        const debugContent = document.getElementById('debug-content');

        function pushLog(line) {
            const ts = new Date().toLocaleTimeString();
            logEl.textContent = `${ts} ‚Äî ${line}\n` + logEl.textContent;
            if (logEl.textContent.length > 20000) {
                logEl.textContent = logEl.textContent.slice(0, 20000);
            }
        }

        function showAlert(type, msg) {
            const el = document.getElementById(type);
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 6000);
        }

        function showError(msg) {
            showAlert('error', msg);
        }

        function showSuccess(msg) {
            showAlert('success', msg);
        }

        function showInfo(msg) {
            showAlert('info', msg);
        }

        async function callApi(path, opts = {}) {
            try {
                const res = await fetch(path, {
                    ...opts,
                    headers: {
                        'Content-Type': 'application/json',
                        ...opts.headers
                    }
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                return await res.json();
            } catch (err) {
                pushLog(`‚ùå API Error: ${err.message}`);
                throw err;
            }
        }

        async function verDebug() {
            try {
                const data = await callApi('/producto');
                debugPanel.style.display = 'block';

                const productos = Array.isArray(data) ? data : [];
                const resumen = {
                    total: productos.length,
                    con_imagen: productos.filter(p => p.imagen && p.imagen.url_github).length,
                    primeros_3: productos.slice(0, 3)
                };

                debugContent.textContent = JSON.stringify(resumen, null, 2);
                pushLog('Debug cargado');
            } catch (err) {
                showError('No se pudo cargar debug');
            }
        }

        async function procesarImagenes() {
            try {
                document.getElementById('btn-procesar').disabled = true;
                showInfo('‚è≥ Procesando im√°genes...');
                pushLog('Iniciando procesamiento manual...');

                const data = await callApi('/api/productos/procesar-imagenes-manual', {
                    method: 'POST'
                });

                if (data.ok) {
                    showSuccess(data.mensaje || 'Procesamiento iniciado');
                    pushLog(`‚úÖ ${data.mensaje}`);
                } else {
                    showError(data.error || 'Error al procesar');
                    pushLog(`‚ùå Error: ${data.error}`);
                    document.getElementById('btn-procesar').disabled = false;
                }
            } catch (err) {
                showError('Error al procesar im√°genes');
                document.getElementById('btn-procesar').disabled = false;
            }
        }

        function copiarEstado() {
            const estado = {
                total: document.getElementById('total').textContent,
                con_imagen: document.getElementById('con-imagen').textContent,
                sin_imagen: document.getElementById('sin-imagen').textContent,
                porcentaje: document.getElementById('progress-bar').textContent,
                tiempo: document.getElementById('tiempo').textContent
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(JSON.stringify(estado, null, 2))
                    .then(() => {
                        pushLog('Estado copiado');
                        showInfo('‚úÖ Estado copiado al portapapeles');
                    })
                    .catch(() => pushLog('No se pudo copiar'));
            } else {
                pushLog('Clipboard no disponible');
            }
        }

        async function actualizarProgreso() {
            try {
                const data = await callApi('/producto');
                errorCount = 0;

                if (!Array.isArray(data)) {
                    throw new Error('Respuesta inv√°lida del servidor');
                }

                const total = data.length;
                const conImagen = data.filter(p => p.imagen && p.imagen.url_github).length;
                const sinImagen = total - conImagen;
                const porcentaje = total > 0 ? ((conImagen / total) * 100).toFixed(1) : 0;

                // Actualizar UI
                document.getElementById('estado').textContent = 'üìä';
                document.getElementById('mensaje').textContent = `${conImagen} de ${total} productos con imagen`;
                document.getElementById('badge-estado').textContent = 'Conectado';

                // Barra de progreso
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = porcentaje + '%';
                progressBar.textContent = porcentaje + '%';

                // Stats
                document.getElementById('total').textContent = total.toLocaleString();
                document.getElementById('con-imagen').textContent = conImagen.toLocaleString();
                document.getElementById('sin-imagen').textContent = sinImagen.toLocaleString();

                // Tiempo estimado
                if (sinImagen > 0) {
                    const minutos = Math.ceil((sinImagen / 50) * 2);
                    document.getElementById('tiempo').textContent =
                        minutos < 60 ? `${minutos}m` : `${Math.floor(minutos/60)}h ${minutos%60}m`;
                } else {
                    document.getElementById('tiempo').textContent = 'Completo';
                }

                // Timestamp
                document.getElementById('timestamp').textContent =
                    '√öltima actualizaci√≥n: ' + new Date().toLocaleString('es-MX');

                pushLog(`‚úÖ ${conImagen}/${total} (${porcentaje}%)`);

            } catch (err) {
                errorCount++;
                document.getElementById('badge-estado').textContent = 'Error';
                pushLog(`‚ùå Error de conexi√≥n (${errorCount})`);

                if (errorCount === 1) {
                    showError('Error de conexi√≥n con el servidor');
                }
            }
        }

        // Iniciar
        actualizarProgreso();
        setInterval(actualizarProgreso, 5000);

        pushLog('Panel iniciado correctamente');
    </script>
</body>

</html>